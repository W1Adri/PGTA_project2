name: Build Release Executables

on:
  push:
    branches: [ release ]

jobs:
  # ── 1. Generate shared build date ──────────────────────────────────────────
  prepare:
    runs-on: ubuntu-latest
    outputs:
      date: ${{ steps.date.outputs.date }}
    steps:
      - name: Get build date
        id: date
        run: echo "date=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_OUTPUT

  # ── 2. Build Linux & Windows in parallel ───────────────────────────────────
  build:
    needs: prepare
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
            separator: ":"
            ext: ""
            extra_imports: >-
              --hidden-import webview.platforms.gtk
          - os: windows-latest
            name: windows
            separator: ";"
            ext: ".exe"
            extra_imports: >-
              --hidden-import webview.platforms.winforms
              --hidden-import webview.platforms.edgechromium
              --hidden-import clr
              --hidden-import System
              --hidden-import System.Windows.Forms
              --collect-all pythonnet

    runs-on: ${{ matrix.os }}
    name: Build — ${{ matrix.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (Linux)
        if: matrix.name == 'linux'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install dependencies (Windows)
        if: matrix.name == 'windows'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          pip install pythonnet pywebview[qt]

      - name: Build executable
        run: >
          pyinstaller
          --onefile
          --noconsole
          --name asterix_decoder_${{ matrix.name }}_${{ needs.prepare.outputs.date }}
          --add-data "ui${{ matrix.separator }}ui"
          --hidden-import uvicorn
          --hidden-import uvicorn.main
          --hidden-import uvicorn.config
          --hidden-import uvicorn.server
          --hidden-import uvicorn.logging
          --hidden-import uvicorn.loops
          --hidden-import uvicorn.loops.auto
          --hidden-import uvicorn.loops.asyncio
          --hidden-import uvicorn.loops.uvloop
          --hidden-import uvicorn.protocols
          --hidden-import uvicorn.protocols.http
          --hidden-import uvicorn.protocols.http.auto
          --hidden-import uvicorn.protocols.http.h11_impl
          --hidden-import uvicorn.protocols.http.httptools_impl
          --hidden-import uvicorn.protocols.websockets
          --hidden-import uvicorn.protocols.websockets.auto
          --hidden-import uvicorn.protocols.websockets.websockets_impl
          --hidden-import uvicorn.protocols.websockets.wsproto_impl
          --hidden-import uvicorn.lifespan
          --hidden-import uvicorn.lifespan.on
          --hidden-import uvicorn.lifespan.off
          --hidden-import starlette.routing
          --hidden-import starlette.staticfiles
          --hidden-import starlette.middleware.cors
          --hidden-import starlette.middleware.base
          --hidden-import websockets
          --hidden-import websockets.legacy
          --hidden-import websockets.legacy.server
          --hidden-import websockets.legacy.client
          --collect-all uvicorn
          ${{ matrix.extra_imports }}
          main.py

      - name: Upload binary as artifact (temp, picked up by release job)
        uses: actions/upload-artifact@v4
        with:
          name: binary_${{ matrix.name }}
          path: dist/asterix_decoder_${{ matrix.name }}_${{ needs.prepare.outputs.date }}${{ matrix.ext }}
          retention-days: 1

  # ── 3. Create a permanent GitHub Release with both binaries ────────────────
  release:
    needs: [ prepare, build ]
    runs-on: ubuntu-latest
    name: Create GitHub Release
    permissions:
      contents: write

    steps:
      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: binary_linux
          path: dist/

      - name: Download Windows binary
        uses: actions/download-artifact@v4
        with:
          name: binary_windows
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: release-${{ needs.prepare.outputs.date }}
          name: "ASTERIX Decoder — ${{ needs.prepare.outputs.date }}"
          body: |
            Automated build from the `release` branch.

            **Downloads**
            - `asterix_decoder_linux_*` — run on Linux (chmod +x required)
            - `asterix_decoder_windows_*.exe` — run on Windows (requires WebView2 runtime)
          draft: false
          prerelease: false
          files: |
            dist/*
          make_latest: true